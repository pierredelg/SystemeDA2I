#!/bin/bash

#On recupere le chemin de la racine des fichiers
#et le chemin du modele HTML provenant du script http-server
cheminRacine=$1
cheminModele=$2
set -x

#fonction permettant de supprimer le \r pour chaque ligne
format(){
	echo "$1" | tr -d '\r'
}

##Le script ne traite qu'une seule requete et ensuite quitte

#On lit la 1ere ligne
read methode ressource version

#On retire le \r de la version
version=$(format "$version")

#Si la methode n'est pas GET
if [ ! "$methode" = 'GET' ]
	then
		status='405 Method Not Allowed'
		tailleReponse='22'
		fichier=$status
#Si la version ne correspond pas à la version 1 de HTTP
elif [ ! "$version" = 'HTTP/1.1' ]
	then
		status='505 HTTP Version Not Supported'
		tailleReponse='30'
		fichier=$status
fi


#On teste le /contenu ou /html
testAction=$(echo "$ressource" | cut -d "/" -f1)
ressource=$(echo "$ressource" | cut -d "/" -f2)

if [ "$testAction" = 'contenu' ]
then
	ressource=$(echo "$cheminRacine""$ressource")

#Si la ressource est bien un fichier
	if [ -f "$ressource" ]
	then
  		status='200 OK'
  		tailleReponse=$(ls -lh $ressource| cut -d " " -f5)
  	 	fichier=$(cat "$ressource")
  	else
  		status='406 Not Acceptable'
  		tailleReponse='18'
  		fichier=$status
  	fi

elif [ "$testAction" = 'html' ]
then

fi


# #Si la ressource n'existe pas
# if [ ! -e "$ressource" ]
# 	then
#   		status='404 Not Found'
#   		tailleReponse='13'
#   		fichier=$status


# #Si la ressource est un dossier
# elif [ ! -r "$ressource" ]
# 	then
#   		status='403 Forbidden'
#   		tailleReponse='13'
#   		fichier=$status
# fi


#sinon 406 


#On ignore la suite
while read ligne
do
	ligne=$(format "$ligne")
	if [ "$ligne" = "" ]
	then
		break;
	fi
done

#On teste le content-type
contentType="text/html"

#On prepare la réponse au format http
ligneReponse1="HTTP/1.1 $status"
printf "%s\r\n" "$ligneReponse1"
ligneReponse2="Content-length: $tailleReponse"
printf "%s\r\n" "$ligneReponse2"
ligneReponse3="Content-type: $contentType ; charset=UTF-8"
printf "%s\r\n" "$ligneReponse3"
printf "\r\n"
printf "%s\r\n" "$fichier"


#reponse:
#code = [0-9]{3}
#code géré 200, 400 ,404 ,(méthode non supportée)



#le content-type est vérifié et reconnu par l'extension du fichier 
# les types mimes sont dans /etc/mime.types

#On utilise printf au lieu d'echo pour envoyer les données.

